# ROS Navigation 系统架构详解

## 系统架构总览
ROS Navigation Stack 是用于机器人自主导航的核心框架，基于模块化设计，主要包含以下核心节点和组件：
- **输入**：里程计（Odometry）、激光雷达/RGB-D 传感器数据、先验地图（可选）、坐标系变换（TF）
- **输出**：速度控制命令（`cmd_vel`）[[1,3]]
- **核心节点**：`move_base`（协调全局/局部规划）、`map_server`（地图服务）、`amcl`（定位）

---

## 核心节点机制

### 1. map_server
- **功能**：提供静态地图（如SLAM生成的`.pgm`地图），通过`/map`话题发布`nav_msgs/OccupancyGrid`类型的地图数据。
- **关键配置**：需调整地图原点坐标（`origin`）和分辨率（`resolution`），确保与物理环境对齐。

### 2. amcl（自适应蒙特卡洛定位）
- **输入**：激光扫描数据（`/scan`）、初始位姿（`/initialpose`）、地图（`/map`）。
- **输出**：机器人在地图中的估计位姿（`/amcl_pose`）、粒子云（`/particlecloud`）以及`map`到`odom`的TF变换[[9,17]]。
- **定位原理**：基于粒子滤波算法，结合传感器数据与地图实现动态定位。

### 3. move_base（导航核心）
- **功能模块**：
  - **全局规划器（Global Planner）**  ：使用A*或Dijkstra算法生成起点到目标的最优路径。
  - **局部规划器（Local Planner）**  ：采用DWA（Dynamic Window Approach）或TEB（Timed Elastic Band）算法，实时避障并跟踪全局路径。
  - **全局代价地图（Global Costmap）**  ：基于先验地图生成，包含静态障碍物信息，用于全局路径规划。
  - **局部代价地图（Local Costmap）**  ：动态更新传感器数据（如激光雷达），处理实时障碍物，用于局部路径调整。
  - **恢复行为（Recovery Behaviors）**  ：当路径规划失败时，执行旋转或清理代价地图等恢复策略。

---

## 全局与局部地图对比

| 特性         | 全局代价地图                     | 局部代价地图                 |
| ------------ | -------------------------------- | ---------------------------- |
| **数据来源** | 预先加载的静态地图（`/map`话题） | 实时传感器数据（如激光雷达） |
| **更新频率** | 低（仅在初始化时加载）           | 高（实时更新，通常10Hz以上） |
| **作用范围** | 覆盖整个环境                     | 限定在机器人周围（如5m×5m）  |
| **规划用途** | 全局路径规划（长距离）           | 局部避障与轨迹优化（短距离） |
| **典型算法** | A*、Dijkstra                     | DWA、TEB                     |

---

## 关键参数配置
- **全局代价地图参数**：定义障碍物膨胀半径、地图层叠加方式等（`global_costmap_params.yaml`）。
- **局部代价地图参数**：设置更新频率、传感器观测范围（`local_costmap_params.yaml`）[[16]]。
- **规划器参数**：包括最大速度、加速度、目标容差等（如`base_local_planner_params.yaml`）。

---

## 恢复行为（Recovery Behaviors）
当机器人陷入死锁或路径被阻塞时，`move_base`按顺序执行以下恢复策略：
1. **清理局部代价地图**：清除临时障碍物标记。
2. **旋转尝试**：原地旋转以更新传感器数据。
3. **回退操作**：沿原路径后退一定距离。

---

## 典型数据流
1. **初始化**：`map_server`加载地图，`amcl`提供初始定位。
2. **全局规划**：`global_planner`生成全局路径（`/global_plan`）。
3. **局部调整**：`local_planner`结合实时传感器数据更新局部路径（`/local_plan`）。
4. **控制执行**：速度命令通过`/cmd_vel`发送到底层驱动。

> 参考文档（[ROS Navigation Wiki](http://wiki.ros.org/navigation)）。